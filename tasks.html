<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="manifest" href="manifest.json">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Study Planner – Tasks</title>
  <link rel="stylesheet" href="gome.css">
  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>
<body>
  <div class="app-container">
    <div class="content-section active" id="tasksSection">
      <div class="full-task-card">
        <div class="card-header">
          <h3><span class="material-icons">assignment</span> All Tasks</h3>
        </div>
        <div class="task-list" id="tasksList">
          <!-- Tasks will be loaded here from Firestore -->
        </div>
      </div>
    </div>

    <!-- Floating Add-Task Button -->
    <div class="fab-container">
      <button class="fab-main material-icons" id="addTaskFab">add</button>
    </div>

    <nav class="tab-bar">
  <a href="home.html" class="tab-item">
    <span class="material-icons">calendar_today</span>
    <span class="tab-label">Home</span>
  </a>
  <a href="tasks.html" class="tab-item active">
    <span class="material-icons">assignment</span>
    <span class="tab-label">Tasks</span>
  </a>
  <a href="classes.html" class="tab-item">
    <span class="material-icons">class</span>
    <span class="tab-label">Classes</span>
  </a>
  <a href="profile.html" class="tab-item">
    <span class="material-icons">person</span>
    <span class="tab-label">Profile</span>
  </a>
</nav>

  </div>

  <!-- ✅ Firebase and Firestore -->


<!-- ✅ Firebase and Firestore -->
<script type="module">
  import { db, auth } from './firebase-init.js';
  import {
    collection,
    deleteDoc,
    doc,
    query,
    where,
    orderBy,
    onSnapshot
  } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

  const tasksList = document.getElementById("tasksList");

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.href = 'login.html';
      return;
    }

    const displayTasks = (tasks) => {
      tasksList.innerHTML = "";

      if (!tasks.length) {
        tasksList.innerHTML = "<p style='text-align:center;color:gray;'>No tasks found. Start by adding one!</p>";
        return;
      }

      tasks.forEach(task => {
        const dueDate = new Date(task.dueDate);
        const options = {
          weekday: 'short',
          year: 'numeric',
          month: 'short',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        };

        const div = document.createElement("div");
        div.className = "task-item";
        div.innerHTML = `
          <div class="task-info">
            <h4>${task.name}</h4>
            <p>${task.description}</p>
            <span class="deadline">Deadline: ${dueDate.toLocaleDateString('en-US', options)}</span>
          </div>
          <div class="task-actions">
            <button class="done-btn">Done</button>
            <button class="delete-btn" data-id="${task.id}">
              <span class="material-icons">delete</span>
            </button>
          </div>
        `;
        tasksList.appendChild(div);
      });

      document.querySelectorAll(".done-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          btn.closest(".task-item").classList.toggle("done");
        });
      });

      document.querySelectorAll(".delete-btn").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.getAttribute("data-id");
          try {
            await deleteDoc(doc(db, "tasks", id));
            btn.closest(".task-item").remove();

            const cached = localStorage.getItem("tasks");
            if (cached) {
              const updated = JSON.parse(cached).filter(t => t.id !== id);
              localStorage.setItem("tasks", JSON.stringify(updated));
            }

            if (!tasksList.children.length) {
              tasksList.innerHTML = "<p style='text-align:center;color:gray;'>No tasks found. Start by adding one!</p>";
            }

          } catch (error) {
            console.error("Delete failed:", error);
            alert("Failed to delete task. Please try again.");
          }
        });
      });
    };

    const cached = localStorage.getItem("tasks");
    if (cached) {
      try {
        displayTasks(JSON.parse(cached));
      } catch (e) {
        console.warn("Invalid cache");
      }
    }

    const q = query(
      collection(db, "tasks"),
      where("userId", "==", user.uid),
      orderBy("dueDate")
    );

    onSnapshot(q, (snapshot) => {
      const tasks = snapshot.docs.map(docSnap => ({
        ...docSnap.data(),
        id: docSnap.id
      }));
      displayTasks(tasks);
      localStorage.setItem("tasks", JSON.stringify(tasks));
    });

    document.getElementById("addTaskFab").addEventListener("click", () => {
      window.location.href = "add-task.html";
    });
  });
</script>



</body>
</html>



