<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="manifest" href="manifest.json">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Study Planner â€“ Classes</title>
  <link rel="stylesheet" href="gome.css" />
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
  <style>
    .class-time {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .class-time .day {
      color: #000 !important;
      font-weight: 600;
      margin-bottom: 0.2rem;
    }
    .class-list .class-item {
      border-left: 4px solid var(--primary);
    }
  </style>
</head>
<body>
  <div class="app-container">
    <div class="content-section active" id="classesSection">
      <div class="full-class-card">
        <div class="card-header">
          <h3><span class="material-icons">school</span> All Classes</h3>
        </div>
        <div class="class-list" id="classesList">
          <!-- Firebase class items will be loaded here -->
        </div>
      </div>
    </div>

    <div class="fab-container">
      <button class="fab-main material-icons" id="addClassFab">add</button>
    </div>

    <nav class="tab-bar">
      <a href="home.html" class="tab-item"><span class="material-icons">calendar_today</span><span class="tab-label">Home</span></a>
      <a href="tasks.html" class="tab-item"><span class="material-icons">assignment</span><span class="tab-label">Tasks</span></a>
      <a href="classes.html" class="tab-item active"><span class="material-icons">class</span><span class="tab-label">Classes</span></a>
      <a href="profile.html" class="tab-item"><span class="material-icons">person</span><span class="tab-label">Profile</span></a>
    </nav>
  </div>
<script type="module" src="firebase-init.js"></script>
<script type="module">
  import { db, auth } from "./firebase-init.js";
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
// Update imports to include onSnapshot
import { 
  collection, 
  deleteDoc, 
  doc, 
  query, 
  where, 
  getDocs,
  onSnapshot  // Add this
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  const classesList = document.getElementById("classesList");

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.href = 'login.html';
      return;
    }

    const displayClasses = (classes) => {
      classesList.innerHTML = "";

      if (!classes.length) {
        classesList.innerHTML = "<p style='text-align:center; color:gray;'>No classes found. Add your first class!</p>";
        return;
      }

      classes.forEach(d => {
        const div = document.createElement("div");
        div.className = "class-item";

        const timeString = d.time || `${d.startTime} - ${d.endTime}`;
        const [start, end] = timeString.split("-").map(t => t.trim());
        const start12h = to12Hour(start);
        const end12h = to12Hour(end);

        div.innerHTML = `
          <div class="class-layout">
            <div class="class-time">
              <span class="day">${d.days}</span>
              <span class="time">${start12h} - ${end12h}</span>
              <button class="delete-btn small-btn" data-id="${d.id}">
                <span class="material-icons">delete</span>
              </button>
            </div>
            <div class="class-info">
              <div class="class-title-row">
                <h4 class="class-title">${d.name}</h4>
              </div>
              <p class="instructor">${d.instructor || ''}</p>
            </div>
          </div>
        `;

        classesList.appendChild(div);
      });

      // Delete button listeners
      document.querySelectorAll(".delete-btn").forEach(btn => {
        btn.addEventListener("click", async () => {
          const confirmDelete = confirm("Are you sure you want to delete this class?");
          if (!confirmDelete) return;

          const id = btn.dataset.id;
          await deleteDoc(doc(db, "classes", id));
          btn.closest(".class-item").remove();

          // Update cache
          const cached = localStorage.getItem("classes");
          if (cached) {
            const updated = JSON.parse(cached).filter(cls => cls.id !== id);
            localStorage.setItem("classes", JSON.stringify(updated));
          }

          if (!classesList.children.length) {
            classesList.innerHTML = "<p style='text-align:center; color:gray;'>No classes found. Add your first class!</p>";
          }
        });
      });
    };

    const loadClasses = async () => {
      // Show cached classes immediately
      const cached = localStorage.getItem("classes");
      if (cached) {
        try {
          const parsed = JSON.parse(cached);
          displayClasses(parsed);
        } catch (err) {
          console.warn("Failed to parse cached classes:", err);
        }
      }

      // Fetch from Firestore
      try {
        const q = query(
          collection(db, "classes"),
          where("userId", "==", user.uid)
        );
   
onSnapshot(q, 
  (snap) => {
    const classes = snap.docs.map(docSnap => ({
      ...docSnap.data(),
      id: docSnap.id
    }));
    displayClasses(classes);
    localStorage.setItem("classes", JSON.stringify(classes));
  },
  (error) => {  // Add error handler
    console.error("Real-time listener error:", error);
    classesList.innerHTML = `
      <p style="color: red; text-align: center; padding: 20px;">
        Connection error: ${error.message}
      </p>`;
  }
);
  

      } catch (error) {
        console.error("Error loading classes:", error);
        classesList.innerHTML = `
          <p style="color: red; text-align: center; padding: 20px;">
            Error loading classes: ${error.message}
          </p>
        `;
      }
    };

    // Time conversion helper
    function to12Hour(t) {
      const [H, M] = t.split(":").map(Number);
      const ampm = H >= 12 ? "PM" : "AM";
      const h12 = H % 12 || 12;
      const m2 = M.toString().padStart(2, '0');
      return `${h12}:${m2} ${ampm}`;
    }

    loadClasses();
  });

  document.getElementById('addClassFab').addEventListener('click', () => {
    window.location.href = 'add-class.html';
  });
</script>
      
</body>
</html>




