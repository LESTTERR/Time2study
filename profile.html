<html lang="en">
<head>
  <link rel="manifest" href="manifest.json">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Study Planner â€“ Profile</title>
  <link rel="stylesheet" href="gome.css">
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="profile.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">


</head>

<body>
  <div class="app-container">
    <div class="content-section active" id="profileSection">
      <div class="profile-card">
        <div class="profile-header">
          <div class="profile-pic">
            <span class="material-icons">account_circle</span>
          </div>
          <h2 id="userName">Loadig...</h2>
        </div>

        <div class="profile-info">
          <div class="info-row">
            <span class="material-icons">email</span>
            <input type="email" id="userEmail" disabled>
          </div>
          <div class="info-row">
            <span class="material-icons">school</span>
            <input type="text" id="userSchool" disabled>
          </div>
          <div class="info-row">
            <span class="material-icons">person</span>
            <input type="text" id="userAge" disabled>
          </div>
        </div>

        <div class="profile-buttons">
          <button class="edit-btn" id="editBtn">Edit</button>
          <button class="save-btn" id="saveBtn" style="display: none;">Save</button>
          <button class="logout-btn" id="logoutBtn">Log Out</button>
        </div>
      </div>
    </div>

   <nav class="tab-bar">
  <a href="home.html" class="tab-item">
    <span class="material-icons">calendar_today</span>
    <span class="tab-label">Home</span>
  </a>
  <a href="tasks.html" class="tab-item">
    <span class="material-icons">assignment</span>
    <span class="tab-label">Tasks</span>
  </a>
  <a href="classes.html" class="tab-item">
    <span class="material-icons">class</span>
    <span class="tab-label">Classes</span>
  </a>
  <a href="profile.html" class="tab-item active">
    <span class="material-icons">person</span>
    <span class="tab-label">Profile</span>
  </a>
</nav>
  </div>
 
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDBZ7tcCJJdGCo7C8FXRiUPQ8OfOzexllc",
    authDomain: "time2study-4f2f3.firebaseapp.com",
    projectId: "time2study-4f2f3",
    storageBucket: "time2study-4f2f3.appspot.com",
    messagingSenderId: "856561565211",
    appId: "1:856561565211:web:e59307f6c4dcb7a52582be",
    measurementId: "G-9S9C5D6TXF"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const userName = document.getElementById('userName');
  const userEmail = document.getElementById('userEmail');
  const userSchool = document.getElementById('userSchool');
  const userAge = document.getElementById('userAge');
  const editBtn = document.getElementById('editBtn');
  const saveBtn = document.getElementById('saveBtn');
  const inputs = document.querySelectorAll('#profileSection input');

  const setLoadingState = () => {
    userName.textContent = "Loading...";
    userEmail.value = "";
    userSchool.value = "";
    userAge.value = "";
  };

  const loadProfile = async (uid) => {
    setLoadingState();
    try {
      const userDoc = await getDoc(doc(db, "users", uid));
      if (userDoc.exists()) {
        const data = userDoc.data();
        userName.textContent = data.fullName || 'Not set';
        userEmail.value = data.email || 'Not set';
        userSchool.value = data.school || 'Not set';
        userAge.value = data.age || 'Not set';
      } else {
        userName.textContent = "User not found";
      }
    } catch (error) {
      userName.textContent = "Error loading profile";
      alert(`Error loading profile: ${error.message}`);
    }
  };

  onAuthStateChanged(auth, (user) => {
    if (user) {
      loadProfile(user.uid);
    } else {
      window.location.href = 'login.html';
    }
  });

  editBtn.addEventListener('click', () => {
    inputs.forEach(input => input.disabled = false);
    editBtn.style.display = 'none';
    saveBtn.style.display = 'inline-block';
  });

  saveBtn.addEventListener('click', async () => {
    try {
      const user = auth.currentUser;
      if (!user) return;
      await updateDoc(doc(db, "users", user.uid), {
        fullName: userName.textContent,
        school: userSchool.value,
        age: Number(userAge.value)
      });
      inputs.forEach(input => input.disabled = true);
      saveBtn.style.display = 'none';
      editBtn.style.display = 'inline-block';
      alert('Profile updated successfully!');
    } catch (error) {
      alert(`Error saving profile: ${error.message}`);
    }
  });

  function logout() {
  sessionStorage.clear(); // or sessionStorage.removeItem('loggedIn');
  window.location.href = 'login.html';
}


  document.getElementById('logoutBtn').addEventListener('click', async () => {
    try {
      await signOut(auth);
      window.location.href = 'login.html';
    } catch (error) {
      alert(`Logout failed: ${error.message}`);
    }
  });
</script>
<!-- Draggable Chatbot Container -->
<div id="draggable-chatbot">
  <div class="drag-header">
    <span>StudyBot</span>
    <button id="close-chatbot" title="Close">&times;</button>
  </div>
 
<df-messenger
  intent="WELCOME"
  chat-title="T2SBOT"
  agent-id="4558beea-12ba-46e0-9f37-0a0c394f92ec"
  language-code="en"
></df-messenger>
</div>
<button id="open-chatbot" title="Open Chatbot" style="display:none;">
  <span class="material-icons">chat</span>
</button>
<!-- Draggable Chatbot Styles and Script -->
<style>
  #draggable-chatbot {
    position: fixed;
    bottom: 120px;
    right: 24px;
    z-index: 9999;
    cursor: move;
    width: 370px;
    max-width: 90vw;
    background: none;
    transition: box-shadow 0.2s;
  }
  #draggable-chatbot .drag-header {
    width: 100%;
    height: 28px;
    background: #4285f4;
    color: #fff;
    font-size: 14px;
    padding: 4px 12px;
    border-radius: 8px 8px 0 0;
    user-select: none;
    cursor: move;
    display: flex;
    align-items: center;
    justify-content: space-between;
    touch-action: none;
  }
  #draggable-chatbot .drag-header span {
    flex: 1;
  }
  #draggable-chatbot .drag-header button {
    background: transparent;
    border: none;
    color: #fff;
    font-size: 18px;
    cursor: pointer;
    margin-left: 8px;
  }
  #draggable-chatbot[hidden] {
    display: none;
  }
  /* Remove default shadow from df-messenger */
  #draggable-chatbot df-messenger {
    box-shadow: none !important;
    border-radius: 0 0 8px 8px;
  }
  #open-chatbot {
    position: fixed;
    bottom: 120px;
    right: 24px;
    z-index: 9998;
    background: #4285f4;
    color: #fff;
    border: none;
    border-radius: 50%;
    width: 56px;
    height: 56px;
    font-size: 32px;
    display: none;
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  }

  /* Mobile-friendly adjustments */
  @media (max-width: 768px) {
    #draggable-chatbot {
      width: 98vw;
      min-width: 0;
      max-width: 98vw;
      left: 1vw !important;
      right: auto !important;
      bottom: 80px !important;
      top: auto !important;
      height: 60vh;
      max-height: 70vh;
    }
    #draggable-chatbot .drag-header {
      font-size: 16px;
      height: 36px;
      padding: 8px 16px;
    }
  }
</style>
<script>
  // Drag functionality with mouse and touch support
  const chatbot = document.getElementById('draggable-chatbot');
  if (chatbot) {
    const dragHeader = chatbot.querySelector('.drag-header');
    let offsetX = 0, offsetY = 0, isDragging = false;

    function throttle(func, limit) {
      let lastFunc;
      let lastRan;
      return function(...args) {
        const context = this;
        if (!lastRan) {
          func.apply(context, args);
          lastRan = Date.now();
        } else {
          clearTimeout(lastFunc);
          lastFunc = setTimeout(function() {
            if (Date.now() - lastRan >= limit) {
              func.apply(context, args);
              lastRan = Date.now();
            }
          }, limit - (Date.now() - lastRan));
        }
      };
    }

    const setPosition = throttle((x, y) => {
      // Keep inside viewport
      x = Math.max(0, Math.min(window.innerWidth - chatbot.offsetWidth, x));
      y = Math.max(0, Math.min(window.innerHeight - chatbot.offsetHeight, y));
      chatbot.style.left = x + 'px';
      chatbot.style.top = y + 'px';
      chatbot.style.right = 'auto';
      chatbot.style.bottom = 'auto';
    }, 50);

    dragHeader.addEventListener('mousedown', function(e) {
      isDragging = true;
      offsetX = e.clientX - chatbot.getBoundingClientRect().left;
      offsetY = e.clientY - chatbot.getBoundingClientRect().top;
      document.body.style.userSelect = 'none';
    });

    document.addEventListener('mousemove', function(e) {
      if (!isDragging) return;
      setPosition(e.clientX - offsetX, e.clientY - offsetY);
    });

    document.addEventListener('mouseup', function() {
      isDragging = false;
      document.body.style.userSelect = '';
    });

    dragHeader.addEventListener('touchstart', function(e) {
      isDragging = true;
      const touch = e.touches[0];
      offsetX = touch.clientX - chatbot.getBoundingClientRect().left;
      offsetY = touch.clientY - chatbot.getBoundingClientRect().top;
      document.body.style.userSelect = 'none';
    });

    document.addEventListener('touchmove', function(e) {
      if (!isDragging) return;
      const touch = e.touches[0];
      setPosition(touch.clientX - offsetX, touch.clientY - offsetY);
      if (isDragging) {
        e.preventDefault();
      }
    }, { passive: false });

    document.addEventListener('touchend', function() {
      isDragging = false;
      document.body.style.userSelect = '';
    });

    // Show/hide logic
    const closeBtn = document.getElementById('close-chatbot');
    const openBtn = document.getElementById('open-chatbot');
    if (closeBtn) {
      closeBtn.onclick = () => {
        chatbot.hidden = true;
        if (openBtn) openBtn.style.display = 'block';
      };
    }
    if (openBtn) {
      openBtn.onclick = () => {
        chatbot.hidden = false;
        openBtn.style.display = 'none';
      };
    }
  }
</script>
<script src="https://www.gstatic.com/dialogflow-console/fast/messenger/bootstrap.js?v=1"></script>



</body>
</html>
