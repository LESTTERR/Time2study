<html lang="en">
<head>
  <link rel="manifest" href="manifest.json">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Study Planner â€“ Profile</title>
  <link rel="stylesheet" href="gome.css">
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="profile.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">


</head>

<body>
  <div class="app-container">
    <div class="content-section active" id="profileSection">
      <div class="profile-card">
        <div class="profile-header">
          <div class="profile-pic">
            <span class="material-icons">account_circle</span>
          </div>
          <h2 id="userName">Loading...</h2>
        </div>

        <div class="profile-info">
          <div class="info-row">
            <span class="material-icons">email</span>
            <input type="email" id="userEmail" disabled>
          </div>
          <div class="info-row">
            <span class="material-icons">school</span>
            <input type="text" id="userSchool" disabled>
          </div>
          <div class="info-row">
            <span class="material-icons">person</span>
            <input type="number" id="userAge" disabled>
          </div>
        </div>

        <div class="profile-buttons">
          <button class="edit-btn" id="editBtn">Edit</button>
          <button class="save-btn" id="saveBtn" style="display: none;">Save</button>
          <button class="logout-btn" id="logoutBtn">Log Out</button>
        </div>
      </div>
    </div></div>


   <nav class="tab-bar">
  <a href="home.html" class="tab-item">
    <span class="material-icons">calendar_today</span>
    <span class="tab-label">Home</span>
  </a>
  <a href="tasks.html" class="tab-item">
    <span class="material-icons">assignment</span>
    <span class="tab-label">Tasks</span>
  </a>
  <a href="classes.html" class="tab-item">
    <span class="material-icons">class</span>
    <span class="tab-label">Classes</span>
  </a>
  <a href="profile.html" class="tab-item active">
    <span class="material-icons">person</span>
    <span class="tab-label">Profile</span>
  </a>
</nav>

 
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDBZ7tcCJJdGCo7C8FXRiUPQ8OfOzexllc",
    authDomain: "time2study-4f2f3.firebaseapp.com",
    projectId: "time2study-4f2f3",
    storageBucket: "time2study-4f2f3.appspot.com",
    messagingSenderId: "856561565211",
    appId: "1:856561565211:web:e59307f6c4dcb7a52582be",
    measurementId: "G-9S9C5D6TXF"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const userName = document.getElementById('userName');
  const userEmail = document.getElementById('userEmail');
  const userSchool = document.getElementById('userSchool');
  const userAge = document.getElementById('userAge');
  const editBtn = document.getElementById('editBtn');
  const saveBtn = document.getElementById('saveBtn');
  const inputs = document.querySelectorAll('#profileSection input');

  const setLoadingState = () => {
    userName.textContent = "Loading...";
    userEmail.value = "";
    userSchool.value = "";
    userAge.value = "";
  };

  const loadProfile = async (uid) => {
    setLoadingState();
    try {
      const userDoc = await getDoc(doc(db, "users", uid));
      if (userDoc.exists()) {
        const data = userDoc.data();
        userName.textContent = data.fullName || 'Not set';
        userEmail.value = data.email || 'Not set';
        userSchool.value = data.school || 'Not set';
        userAge.value = data.age || 'Not set';
      } else {
        userName.textContent = "User not found";
      }
    } catch (error) {
      userName.textContent = "Error loading profile";
      alert(`Error loading profile: ${error.message}`);
    }
  };

  onAuthStateChanged(auth, (user) => {
    if (user) {
      loadProfile(user.uid);
    } else {
      window.location.href = 'login.html';
    }
  });

  editBtn.addEventListener('click', () => {
    inputs.forEach(input => input.disabled = false);
    editBtn.style.display = 'none';
    saveBtn.style.display = 'inline-block';
  });

  saveBtn.addEventListener('click', async () => {
    try {
      const user = auth.currentUser;
      if (!user) return;
      await updateDoc(doc(db, "users", user.uid), {
        fullName: userName.textContent,
        school: userSchool.value,
        age: Number(userAge.value)
      });
      inputs.forEach(input => input.disabled = true);
      saveBtn.style.display = 'none';
      editBtn.style.display = 'inline-block';
      alert('Profile updated successfully!');
    } catch (error) {
      alert(`Error saving profile: ${error.message}`);
    }
  });

  function logout() {
  sessionStorage.clear(); // or sessionStorage.removeItem('loggedIn');
  window.location.href = 'login.html';
}


  document.getElementById('logoutBtn').addEventListener('click', async () => {
    try {
      await signOut(auth);
      window.location.href = 'login.html';
    } catch (error) {
      alert(`Logout failed: ${error.message}`);
    }
  });
</script>
<div id="chatbot-fab" style="position:fixed;bottom:49px;right:32px;z-index:9999;cursor:pointer;display:flex;align-items:center;justify-content:center;width:98px;height:75px;background:rgba(255,255,255,0.95);border-radius:50%;">
  <span class="material-icons" style="color:#27c2ed;font-size:45px;">smart_toy</span>
</div>
<div id="chatbot-window" style="display:none;position:fixed;bottom:104px;right:32px;width:340px;max-width:95vw;background:#fff;border-radius:18px;box-shadow:0 8px 32px rgba(30,60,114,0.18);overflow:hidden;z-index:10000;flex-direction:column;">
  <div style="background:#2f3dff;color:#fff;padding:16px 20px;display:flex;align-items:center;justify-content:space-between;">
    <span style="font-weight:600;font-size:1.1rem;">T2S Chatbot</span>
    <span id="chatbot-close" class="material-icons" style="cursor:pointer;">close</span>
  </div>
  <div id="messages" style="padding:16px;height:260px;overflow-y:auto;background:#f7fafd;font-size:0.98rem;"></div>
  <div style="display:flex;align-items:center;padding:12px 16px;border-top:1px solid #eee;background:#fafbfc;">
    <input id="userInput" type="text" placeholder="Type a message..." style="flex:1;padding:8px 12px;border-radius:16px;border:1px solid #ddd;outline:none;font-size:1rem;">
    <button id="chatbot-send" style="margin-left:8px;background:#2196F3;border:none;border-radius:50%;width:40px;height:40px;display:flex;align-items:center;justify-content:center;cursor:pointer;">
      <span class="material-icons" style="color:#fff;">send</span>
    </button>
  </div>
</div>


<script>
const fab = document.getElementById('chatbot-fab');
const chatWindow = document.getElementById('chatbot-window');
const closeBtn = document.getElementById('chatbot-close');
const sendBtn = document.getElementById('chatbot-send');
const input = document.getElementById('userInput');
const messages = document.getElementById('messages');

// Show chat window when FAB is clicked
fab.onclick = () => {
  chatWindow.style.display = 'flex';
  fab.style.display = 'none';
  input.focus();
};

// Hide chat window when close is clicked
closeBtn.onclick = () => {
  chatWindow.style.display = 'none';
  fab.style.display = 'flex';
};

// Send message on button click or Enter key
sendBtn.onclick = sendMessage;
input.addEventListener('keydown', e => {
  if (e.key === 'Enter') sendMessage();
});

async function sendMessage() {
  const text = input.value.trim();
  if (!text) return;
  addMessage('user', text);
  input.value = '';
  input.disabled = true;
  sendBtn.disabled = true;
  await sendMessageToDialogflow(text);
  input.disabled = false;
  sendBtn.disabled = false;
  input.focus();
}

async function sendMessageToDialogflow(message, sessionId = 'user-123') {
  addMessage('bot', '...');
  try {
    const response = await fetch('https://frontendapichatbot.vercel.app/api/dialogflow', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message, sessionId })
    });
    const data = await response.json();
    // Remove the loading "..." message
    messages.removeChild(messages.lastChild);
    addMessage('bot', data.reply || 'Sorry, no reply.');
  } catch (err) {
    messages.removeChild(messages.lastChild);
    addMessage('bot', 'Error connecting to server.');
  }
}

function addMessage(sender, text) {
  const msg = document.createElement('div');
  msg.className = sender;
  msg.textContent = text;
  messages.appendChild(msg);
  messages.scrollTop = messages.scrollHeight;
}
</script>
<script>
function adjustChatbotForKeyboard(up) {
  const chatWindow = document.getElementById('chatbot-window');
  if (up) {
    chatWindow.classList.add('keyboard-up');
  } else {
    chatWindow.classList.remove('keyboard-up');
  }
}

// For iOS and Android: listen for focus/blur on the input
input.addEventListener('focus', () => adjustChatbotForKeyboard(true));
input.addEventListener('blur', () => adjustChatbotForKeyboard(false));
</script>
 </div>
</body>
</html>
